<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SplitExpenses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="app"></div>

    <script type="module">
      // ==================== STORE ====================
      class AppStore {
        constructor() {
          this.participants = [];
          this.expenses = [];
          this.payments = [];
          this.sharedExpenses = [];
          this.currentSharedExpenseId = null;
          this.listeners = [];
          this.loadFromStorage();
        }

        getParticipants() {
          return [...this.participants];
        }
        getParticipantByIds(ids) {
          return this.participants.filter((u) => ids.includes(u.id));
        }
        addParticipant(participant) {
          this.participants.push(participant);
          this.saveToStorage();
          this.notify();
        }

        getSharedExpenses() {
          return [...this.sharedExpenses];
        }
        getSharedExpense(id) {
          return this.sharedExpenses.find((se) => se.id === id);
        }
        addSharedExpense(sharedExpense) {
          this.sharedExpenses.push(sharedExpense);
          this.saveToStorage();
          this.notify();
        }
        updateSharedExpense(id, updates) {
          const index = this.sharedExpenses.findIndex((se) => se.id === id);
          if (index !== -1) {
            this.sharedExpenses[index] = {
              ...this.sharedExpenses[index],
              ...updates,
            };
            this.saveToStorage();
            this.notify();
          }
        }
        closeSharedExpense(id) {
          this.updateSharedExpense(id, {
            status: "closed",
            closedAt: new Date().toISOString(),
          });
        }

        getCurrentSharedExpenseId() {
          return this.currentSharedExpenseId;
        }
        setCurrentSharedExpenseId(id) {
          this.currentSharedExpenseId = id;
          this.notify();
        }

        getExpenses() {
          return [...this.expenses];
        }
        getExpensesBySharedExpense(id) {
          return this.expenses.filter((e) => e.sharedExpenseId === id);
        }
        addExpense(expense) {
          this.expenses.push(expense);
          this.saveToStorage();
          this.notify();
        }
        deleteExpense(id) {
          this.expenses = this.expenses.filter((e) => e.id !== id);
          this.saveToStorage();
          this.notify();
        }

        getPayments() {
          return [...this.payments];
        }
        getPaymentsBySharedExpense(id) {
          return this.payments.filter((p) => p.sharedExpenseId === id);
        }
        addPayment(payment) {
          this.payments.push(payment);
          this.saveToStorage();
          this.notify();
        }
        deletePayment(id) {
          this.payments = this.payments.filter((p) => p.id !== id);
          this.saveToStorage();
          this.notify();
        }

        saveToStorage() {
          localStorage.setItem(
            "splitexpenses_users",
            JSON.stringify(this.participants)
          );
          localStorage.setItem(
            "splitexpenses_expenses",
            JSON.stringify(this.expenses)
          );
          localStorage.setItem(
            "splitexpenses_payments",
            JSON.stringify(this.payments)
          );
          localStorage.setItem(
            "splitexpenses_shared",
            JSON.stringify(this.sharedExpenses)
          );
          localStorage.setItem(
            "splitexpenses_current",
            this.currentSharedExpenseId || ""
          );
        }

        loadFromStorage() {
          const usersData = localStorage.getItem("splitexpenses_users");
          const expensesData = localStorage.getItem("splitexpenses_expenses");
          const paymentsData = localStorage.getItem("splitexpenses_payments");
          const sharedData = localStorage.getItem("splitexpenses_shared");
          const currentData = localStorage.getItem("splitexpenses_current");

          if (usersData) this.participants = JSON.parse(usersData);
          if (expensesData) this.expenses = JSON.parse(expensesData);
          if (paymentsData) this.payments = JSON.parse(paymentsData);
          if (sharedData) this.sharedExpenses = JSON.parse(sharedData);
          if (currentData) this.currentSharedExpenseId = currentData || null;

          if (this.participants.length === 0) {
            this.participants = [
              { id: "1", name: "Juan" },
              { id: "2", name: "Valeria" },
              { id: "3", name: "Juana" },
              { id: "4", name: "Pedro" },
              { id: "5", name: "Mar√≠a" },
            ];
            this.saveToStorage();
          }
        }

        subscribe(listener) {
          this.listeners.push(listener);
          return () => {
            this.listeners = this.listeners.filter((l) => l !== listener);
          };
        }

        notify() {
          this.listeners.forEach((listener) => listener());
        }
      }

      // ==================== CALCULATIONS ====================
      function calculateBalances(participants, expenses, payments) {
        const balances = new Map();
        participants.forEach((participant) => balances.set(participant.id, 0));

        const totalExpenses = expenses.reduce(
          (sum, exp) => sum + exp.amount,
          0
        );
        const sharePerPerson = totalExpenses / participants.length;

        participants.forEach((participant) => balances.set(participant.id, -sharePerPerson));
        expenses.forEach((expense) => {
          const current = balances.get(expense.payerId) || 0;
          balances.set(expense.payerId, current + expense.amount);
        });

        payments.forEach((payment) => {
          const fromBalance = balances.get(payment.fromId) || 0;
          const toBalance = balances.get(payment.toId) || 0;
          balances.set(payment.fromId, fromBalance + payment.amount);
          balances.set(payment.toId, toBalance - payment.amount);
        });

        return Array.from(balances.entries()).map(([participantId, balance]) => ({
          participantId,
          balance: Math.round(balance * 100) / 100,
        }));
      }

      function calculateDebts(balances) {
        const debts = [];
        const debtors = balances
          .filter((b) => b.balance < -0.01)
          .map((b) => ({ ...b }));
        const creditors = balances
          .filter((b) => b.balance > 0.01)
          .map((b) => ({ ...b }));

        debtors.sort((a, b) => a.balance - b.balance);
        creditors.sort((a, b) => b.balance - a.balance);

        let i = 0,
          j = 0;

        while (i < debtors.length && j < creditors.length) {
          const debtor = debtors[i];
          const creditor = creditors[j];
          const settleAmount = Math.min(
            Math.abs(debtor.balance),
            creditor.balance
          );

          debts.push({
            fromId: debtor.participantId,
            toId: creditor.participantId,
            amount: Math.round(settleAmount * 100) / 100,
          });

          debtor.balance += settleAmount;
          creditor.balance -= settleAmount;

          if (Math.abs(debtor.balance) < 0.01) i++;
          if (Math.abs(creditor.balance) < 0.01) j++;
        }

        return debts;
      }

      // ==================== APP STATE ====================
      const store = new AppStore();
      let currentView = "list";
      let createStep = 1;
      let newSharedExpenseData = {
        name: "",
        description: "",
        type: "unique",
        participantIds: [],
      };

      // ==================== RENDER FUNCTIONS ====================
      function render() {
        const app = document.getElementById("app");
        const currentId = store.getCurrentSharedExpenseId();
        const currentSharedExpense = currentId
          ? store.getSharedExpense(currentId)
          : null;

        app.innerHTML = `
        <div class="max-w-lg mx-auto ${
          currentView === "list" || currentView.startsWith("create")
            ? "p-4"
            : "p-4 pb-20"
        }">
          ${currentView === "list" ? renderList() : ""}
          ${currentView === "create-step-1" ? renderCreateStep1() : ""}
          ${currentView === "create-step-2" ? renderCreateStep2() : ""}
          ${currentView === "create-step-3" ? renderCreateStep3() : ""}
          ${
            currentView === "dashboard"
              ? renderDashboard(currentSharedExpense)
              : ""
          }
          ${
            currentView === "add-expense"
              ? renderExpenseForm(currentSharedExpense)
              : ""
          }
          ${
            currentView === "add-payment"
              ? renderPaymentForm(currentSharedExpense)
              : ""
          }
          ${
            currentView === "history" ? renderHistory(currentSharedExpense) : ""
          }
        </div>

        ${
          currentView !== "list" && !currentView.startsWith("create")
            ? `
          <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
            <div class="max-w-lg mx-auto flex justify-around py-3">
              <button onclick="setView('dashboard')" class="flex flex-col items-center ${
                currentView === "dashboard" ? "text-blue-600" : "text-gray-600"
              }">
                <span class="text-2xl">üìä</span>
                <span class="text-xs">Dashboard</span>
              </button>
              <button onclick="setView('add-expense')" class="flex flex-col items-center ${
                currentView === "add-expense"
                  ? "text-blue-600"
                  : "text-gray-600"
              }" ${currentSharedExpense?.status === "closed" ? "disabled" : ""}>
                <span class="text-2xl">‚ûï</span>
                <span class="text-xs">Gasto</span>
              </button>
              <button onclick="setView('add-payment')" class="flex flex-col items-center ${
                currentView === "add-payment"
                  ? "text-blue-600"
                  : "text-gray-600"
              }" ${currentSharedExpense?.status === "closed" ? "disabled" : ""}>
                <span class="text-2xl">üí∏</span>
                <span class="text-xs">Pago</span>
              </button>
              <button onclick="setView('history')" class="flex flex-col items-center ${
                currentView === "history" ? "text-blue-600" : "text-gray-600"
              }">
                <span class="text-2xl">üìú</span>
                <span class="text-xs">Historial</span>
              </button>
            </div>
          </nav>
        `
            : ""
        }
      `;
      }

      function renderList() {
        const sharedExpenses = store.getSharedExpenses();

        if (sharedExpenses.length === 0) {
          return `
          <div class="flex flex-col items-center justify-center min-h-screen -mt-20">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">üí∞</div>
              <h1 class="text-2xl font-bold text-gray-800 mb-2">SplitExpenses</h1>
              <p class="text-gray-600 mb-8">A√∫n no tienes gastos compartidos</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm">
              <h3 class="font-semibold text-lg mb-3">¬øC√≥mo funciona?</h3>
              <ul class="space-y-2 text-sm text-gray-600 mb-6">
                <li>‚úì Crea un gasto compartido</li>
                <li>‚úì Agrega participantes</li>
                <li>‚úì Registra gastos y pagos</li>
                <li>‚úì Divide las cuentas autom√°ticamente</li>
              </ul>
              
              <button onclick="startCreate()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                Crear Primer Gasto Compartido
              </button>
            </div>
          </div>
        `;
        }

        return `
        <header class="mb-6">
          <h1 class="text-3xl font-bold text-gray-800">üí∞ Mis Gastos</h1>
          <p class="text-gray-600">Gestiona tus gastos compartidos</p>
        </header>

        <button onclick="startCreate()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium mb-6 hover:bg-blue-700 transition">
          + Crear Nuevo Gasto Compartido
        </button>

        <div class="space-y-4">
          ${sharedExpenses
            .map((se) => {
              const expenses = store.getExpensesBySharedExpense(se.id);
              const totalAmount = expenses.reduce(
                (sum, e) => sum + e.amount,
                0
              );
              const participants = store.getParticipantByIds(se.participantIds);

              return `
              <div onclick="selectSharedExpense('${
                se.id
              }')" class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-md transition">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">${se.name}</h3>
                    ${
                      se.description
                        ? `<p class="text-sm text-gray-600">${se.description}</p>`
                        : ""
                    }
                  </div>
                  <div class="flex gap-2">
                    <span class="px-2 py-1 text-xs rounded ${
                      se.type === "unique"
                        ? "bg-blue-100 text-blue-700"
                        : "bg-purple-100 text-purple-700"
                    }">
                      ${se.type === "unique" ? "√önico" : "Recurrente"}
                    </span>
                    <span class="px-2 py-1 text-xs rounded ${
                      se.status === "active"
                        ? "bg-green-100 text-green-700"
                        : "bg-gray-100 text-gray-700"
                    }">
                      ${se.status === "active" ? "Activo" : "Cerrado"}
                    </span>
                  </div>
                </div>
                
                <div class="flex justify-between items-center text-sm text-gray-600 mt-3">
                  <span>üë• ${participants.length} participantes</span>
                  <span class="font-semibold text-blue-600">$${totalAmount.toFixed(
                    2
                  )}</span>
                </div>
                
                <div class="text-xs text-gray-500 mt-2">
                  Creado: ${new Date(se.createdAt).toLocaleDateString()}
                </div>
              </div>
            `;
            })
            .join("")}
        </div>
      `;
      }

      function renderCreateStep1() {
        return `
        <div class="mb-6">
          <button onclick="setView('list')" class="text-blue-600 flex items-center gap-1 mb-4">
            ‚Üê Volver
          </button>
          <h1 class="text-2xl font-bold text-gray-800">Crear Gasto Compartido</h1>
          <p class="text-gray-600">Paso 1 de 3: Informaci√≥n b√°sica</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <form id="create-step-1-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Nombre *</label>
              <input 
                type="text" 
                name="name" 
                required 
                value="${newSharedExpenseData.name}"
                class="w-full p-2 border rounded" 
                placeholder="Ej: Vacaciones 2024, Gastos Casa"
              >
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Descripci√≥n (opcional)</label>
              <textarea 
                name="description" 
                class="w-full p-2 border rounded" 
                rows="3"
                placeholder="Describe brevemente este gasto compartido"
              >${newSharedExpenseData.description}</textarea>
            </div>

            <div>
              <label class="block text-sm font-medium mb-2">Tipo *</label>
              <div class="space-y-3">
                <label class="flex items-start gap-3 p-3 border rounded cursor-pointer hover:bg-gray-50">
                  <input type="radio" name="type" value="unique" ${
                    newSharedExpenseData.type === "unique" ? "checked" : ""
                  } class="mt-1">
                  <div>
                    <div class="font-medium">√önico</div>
                    <div class="text-sm text-gray-600">Se cierra cuando los balances est√©n correctos seg√∫n el usuario</div>
                  </div>
                </label>
                
                <label class="flex items-start gap-3 p-3 border rounded cursor-pointer hover:bg-gray-50">
                  <input type="radio" name="type" value="recurring" ${
                    newSharedExpenseData.type === "recurring" ? "checked" : ""
                  } class="mt-1">
                  <div>
                    <div class="font-medium">Recurrente</div>
                    <div class="text-sm text-gray-600">Podr√°s cerrar y abrir nuevos per√≠odos (ej: Enero 2025, Febrero 2025)</div>
                  </div>
                </label>
              </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
              Continuar
            </button>
          </form>
        </div>
      `;
      }

      function renderCreateStep2() {
        const allUsers = store.getParticipants();
        const selectedIds = newSharedExpenseData.participantIds;

        return `
        <div class="mb-6">
          <button onclick="goToCreateStep(1)" class="text-blue-600 flex items-center gap-1 mb-4">
            ‚Üê Volver
          </button>
          <h1 class="text-2xl font-bold text-gray-800">Crear Gasto Compartido</h1>
          <p class="text-gray-600">Paso 2 de 3: Selecciona participantes</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Participantes seleccionados</h3>
            <span class="text-sm ${
              selectedIds.length >= 2 ? "text-green-600" : "text-red-600"
            }">
              ${selectedIds.length} / m√≠nimo 2
            </span>
          </div>

          <div class="space-y-2">
            ${allUsers
              .map(
                (participant) => `
              <label class="flex items-center gap-3 p-3 border rounded cursor-pointer hover:bg-gray-50 ${
                selectedIds.includes(participant.id)
                  ? "bg-blue-50 border-blue-300"
                  : ""
              }">
                <input 
                  type="checkbox" 
                  value="${participant.id}" 
                  ${selectedIds.includes(participant.id) ? "checked" : ""}
                  onchange="toggleParticipant('${participant.id}')"
                  class="w-5 h-5"
                >
                <span class="font-medium">${participant.name}</span>
              </label>
            `
              )
              .join("")}
          </div>
        </div>

        <button 
          onclick="goToCreateStep(3)" 
          ${selectedIds.length < 2 ? "disabled" : ""}
          class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          Continuar
        </button>
      `;
      }

      function renderCreateStep3() {
        return `
        <div class="mb-6">
          <button onclick="goToCreateStep(2)" class="text-blue-600 flex items-center gap-1 mb-4">
            ‚Üê Volver
          </button>
          <h1 class="text-2xl font-bold text-gray-800">Crear Gasto Compartido</h1>
          <p class="text-gray-600">Paso 3 de 3: Confirmar</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-4">
          <h3 class="font-semibold mb-4">Resumen</h3>
          
          <div class="space-y-3 text-sm">
            <div>
              <span class="text-gray-600">Nombre:</span>
              <span class="font-medium ml-2">${newSharedExpenseData.name}</span>
            </div>
            
            ${
              newSharedExpenseData.description
                ? `
              <div>
                <span class="text-gray-600">Descripci√≥n:</span>
                <span class="font-medium ml-2">${newSharedExpenseData.description}</span>
              </div>
            `
                : ""
            }
            
            <div>
              <span class="text-gray-600">Tipo:</span>
              <span class="font-medium ml-2">${
                newSharedExpenseData.type === "unique" ? "√önico" : "Recurrente"
              }</span>
            </div>
            
            <div>
              <span class="text-gray-600">Participantes:</span>
              <div class="mt-2 flex flex-wrap gap-2">
                ${store
                  .getParticipantByIds(newSharedExpenseData.participantIds)
                  .map(
                    (participant) => `
                  <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${participant.name}</span>
                `
                  )
                  .join("")}
              </div>
            </div>
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-blue-800">
            ${
              newSharedExpenseData.type === "unique"
                ? "‚úì Este gasto compartido estar√° activo hasta que lo cierres manualmente cuando los balances est√©n correctos."
                : "‚úì Este gasto compartido ser√° recurrente. Podr√°s cerrar per√≠odos y crear nuevos cuando lo necesites."
            }
          </p>
        </div>

        <button 
          onclick="finishCreate()" 
          class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition"
        >
          Crear Gasto Compartido
        </button>
      `;
      }

      function renderDashboard(sharedExpense) {
        if (!sharedExpense)
          return '<div class="text-center p-8">No se encontr√≥ el gasto compartido</div>';

        const participants = store.getParticipantByIds(sharedExpense.participantIds);
        const expenses = store.getExpensesBySharedExpense(sharedExpense.id);
        const payments = store.getPaymentsBySharedExpense(sharedExpense.id);
        const balances = calculateBalances(participants, expenses, payments);
        const debts = calculateDebts(balances);

        const totalExpenses = expenses.reduce(
          (sum, exp) => sum + exp.amount,
          0
        );

        return `
        <header class="mb-6">
          <button onclick="setView('list')" class="text-blue-600 flex items-center gap-1 mb-2">
            ‚Üê Volver a la lista
          </button>
          <div class="flex justify-between items-start">
            <div>
              <h1 class="text-2xl font-bold text-gray-800">${
                sharedExpense.name
              }</h1>
              ${
                sharedExpense.description
                  ? `<p class="text-gray-600">${sharedExpense.description}</p>`
                  : ""
              }
            </div>
            <div class="flex gap-2">
              <span class="px-2 py-1 text-xs rounded ${
                sharedExpense.type === "unique"
                  ? "bg-blue-100 text-blue-700"
                  : "bg-purple-100 text-purple-700"
              }">
                ${sharedExpense.type === "unique" ? "√önico" : "Recurrente"}
              </span>
              <span class="px-2 py-1 text-xs rounded ${
                sharedExpense.status === "active"
                  ? "bg-green-100 text-green-700"
                  : "bg-gray-100 text-gray-700"
              }">
                ${sharedExpense.status === "active" ? "Activo" : "Cerrado"}
              </span>
            </div>
          </div>
        </header>

        ${
          sharedExpense.status === "active"
            ? `
          <button onclick="closeSharedExpense('${sharedExpense.id}')" class="w-full bg-orange-600 text-white py-2 rounded-lg font-medium mb-4 hover:bg-orange-700 transition">
            Cerrar Gasto Compartido
          </button>
        `
            : `
          <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 mb-4 text-center text-sm text-gray-700">
            Este gasto compartido est√° cerrado. No se pueden agregar nuevos gastos o pagos.
          </div>
        `
        }

        <div class="space-y-4">
          <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold mb-2">Resumen Total</h2>
            <p class="text-3xl font-bold text-blue-600">$${totalExpenses.toFixed(
              2
            )}</p>
            <p class="text-sm text-gray-600">${
              expenses.length
            } gastos registrados</p>
          </div>

          <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold mb-3">Balance por Persona</h2>
            <div class="space-y-2">
              ${balances
                .map((b) => {
                  const participant = participants.find((u) => u.id === b.participantId);
                  const isPositive = b.balance > 0.01;
                  const isNegative = b.balance < -0.01;
                  return `
                  <div class="flex justify-between items-center p-2 rounded ${
                    isPositive
                      ? "bg-green-50"
                      : isNegative
                      ? "bg-red-50"
                      : "bg-gray-50"
                  }">
                    <span class="font-medium">${participant?.name}</span>
                    <span class="font-bold ${
                      isPositive
                        ? "text-green-600"
                        : isNegative
                        ? "text-red-600"
                        : "text-gray-600"
                    }">
                      ${isPositive ? "+" : ""}$${b.balance.toFixed(2)}
                    </span>
                  </div>
                `;
                })
                .join("")}
            </div>
          </div>

          ${
            debts.length > 0
              ? `
            <div class="bg-white rounded-lg shadow p-4">
              <h2 class="text-lg font-semibold mb-3">C√≥mo Saldar Cuentas</h2>
              <div class="space-y-2">
                ${debts
                  .map((debt) => {
                    const from = participants.find((u) => u.id === debt.fromId);
                    const to = participants.find((u) => u.id === debt.toId);
                    return `
                    <div class="flex items-center gap-2 p-3 bg-yellow-50 rounded">
                      <span class="font-medium">${from?.name}</span>
                      <span class="text-gray-600">‚Üí</span>
                      <span class="font-medium">${to?.name}</span>
                      <span class="ml-auto font-bold text-yellow-700">$${debt.amount.toFixed(
                        2
                      )}</span>
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            </div>
          `
              : ""
          }
        </div>
      `;
      }

      function renderExpenseForm(sharedExpense) {
        if (!sharedExpense) return "";
        const participants = store.getParticipantByIds(sharedExpense.participantIds);

        return `
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4">Agregar Gasto</h2>
          <form id="expense-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Qui√©n pag√≥</label>
              <select name="payerId" required class="w-full p-2 border rounded">
                ${participants
                  .map((u) => `<option value="${u.id}">${u.name}</option>`)
                  .join("")}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Monto</label>
              <input type="number" name="amount" step="0.01" required class="w-full p-2 border rounded" placeholder="0.00">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
              <input type="text" name="description" required class="w-full p-2 border rounded" placeholder="Ej: Cena">
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded font-medium">Guardar</button>
              <button type="button" onclick="setView('dashboard')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded font-medium">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      }

      function renderPaymentForm(sharedExpense) {
        if (!sharedExpense) return "";
        const participants = store.getParticipantByIds(sharedExpense.participantIds);

        return `
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4">Registrar Pago</h2>
          <form id="payment-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Qui√©n paga</label>
              <select name="fromId" required class="w-full p-2 border rounded">
                ${participants
                  .map((u) => `<option value="${u.id}">${u.name}</option>`)
                  .join("")}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">A qui√©n paga</label>
              <select name="toId" required class="w-full p-2 border rounded">
                ${participants
                  .map((u) => `<option value="${u.id}">${u.name}</option>`)
                  .join("")}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Monto</label>
              <input type="number" name="amount" step="0.01" required class="w-full p-2 border rounded" placeholder="0.00">
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded font-medium">Guardar</button>
              <button type="button" onclick="setView('dashboard')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded font-medium">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      }

      function renderHistory(sharedExpense) {
        if (!sharedExpense) return "";

        const expenses = store.getExpensesBySharedExpense(sharedExpense.id);
        const payments = store.getPaymentsBySharedExpense(sharedExpense.id);
        const participants = store.getParticipantByIds(sharedExpense.participantIds);

        return `
        <div class="space-y-4">
          <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold mb-3">Gastos</h2>
            ${
              expenses.length === 0
                ? '<p class="text-gray-500">No hay gastos registrados</p>'
                : `
              <div class="space-y-2">
                ${expenses
                  .map((exp) => {
                    const payer = participants.find((u) => u.id === exp.payerId);
                    return `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                      <div>
                        <p class="font-medium">${exp.description}</p>
                        <p class="text-sm text-gray-600">${
                          payer?.name
                        } ¬∑ ${new Date(exp.date).toLocaleDateString()}</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="font-bold">${exp.amount.toFixed(2)}</span>
                        ${
                          sharedExpense.status === "active"
                            ? `
                          <button onclick="deleteExpense('${exp.id}')" class="text-red-600 text-sm">üóëÔ∏è</button>
                        `
                            : ""
                        }
                      </div>
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            `
            }
          </div>

          <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold mb-3">Pagos</h2>
            ${
              payments.length === 0
                ? '<p class="text-gray-500">No hay pagos registrados</p>'
                : `
              <div class="space-y-2">
                ${payments
                  .map((pay) => {
                    const from = participants.find((u) => u.id === pay.fromId);
                    const to = participants.find((u) => u.id === pay.toId);
                    return `
                    <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                      <div>
                        <p class="font-medium">${from?.name} ‚Üí ${to?.name}</p>
                        <p class="text-sm text-gray-600">${new Date(
                          pay.date
                        ).toLocaleDateString()}</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="font-bold text-green-600">${pay.amount.toFixed(
                          2
                        )}</span>
                        ${
                          sharedExpense.status === "active"
                            ? `
                          <button onclick="deletePayment('${pay.id}')" class="text-red-600 text-sm">üóëÔ∏è</button>
                        `
                            : ""
                        }
                      </div>
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            `
            }
          </div>
        </div>
      `;
      }

      // ==================== EVENT HANDLERS ====================
      window.setView = (view) => {
        currentView = view;
        render();
      };

      window.startCreate = () => {
        createStep = 1;
        newSharedExpenseData = {
          name: "",
          description: "",
          type: "unique",
          participantIds: [],
        };
        currentView = "create-step-1";
        render();
      };

      window.goToCreateStep = (step) => {
        createStep = step;
        currentView = `create-step-${step}`;
        render();
      };

      window.toggleParticipant = (participantId) => {
        const index = newSharedExpenseData.participantIds.indexOf(participantId);
        if (index === -1) {
          newSharedExpenseData.participantIds.push(participantId);
        } else {
          newSharedExpenseData.participantIds.splice(index, 1);
        }
        render();
      };

      window.finishCreate = () => {
        const sharedExpense = {
          id: Date.now().toString(),
          name: newSharedExpenseData.name,
          description: newSharedExpenseData.description,
          type: newSharedExpenseData.type,
          status: "active",
          participantIds: newSharedExpenseData.participantIds,
          createdAt: new Date().toISOString(),
        };

        store.addSharedExpense(sharedExpense);
        store.setCurrentSharedExpenseId(sharedExpense.id);
        currentView = "dashboard";
        render();
      };

      window.selectSharedExpense = (id) => {
        store.setCurrentSharedExpenseId(id);
        currentView = "dashboard";
        render();
      };

      window.closeSharedExpense = (id) => {
        if (
          confirm(
            "¬øEst√°s seguro de cerrar este gasto compartido? No podr√°s agregar m√°s gastos o pagos."
          )
        ) {
          store.closeSharedExpense(id);
          render();
        }
      };

      window.deleteExpense = (id) => {
        if (confirm("¬øEliminar este gasto?")) {
          store.deleteExpense(id);
        }
      };

      window.deletePayment = (id) => {
        if (confirm("¬øEliminar este pago?")) {
          store.deletePayment(id);
        }
      };

      // Form submissions
      document.addEventListener("submit", (e) => {
        e.preventDefault();
        const form = e.target;

        if (form.id === "create-step-1-form") {
          const formData = new FormData(form);
          newSharedExpenseData.name = formData.get("name");
          newSharedExpenseData.description = formData.get("description");
          newSharedExpenseData.type = formData.get("type");
          goToCreateStep(2);
        }

        if (form.id === "expense-form") {
          const formData = new FormData(form);
          const currentId = store.getCurrentSharedExpenseId();

          store.addExpense({
            id: Date.now().toString(),
            sharedExpenseId: currentId,
            payerId: formData.get("payerId"),
            amount: parseFloat(formData.get("amount")),
            description: formData.get("description"),
            date: new Date().toISOString(),
          });
          currentView = "dashboard";
          render();
        }

        if (form.id === "payment-form") {
          const formData = new FormData(form);
          const fromId = formData.get("fromId");
          const toId = formData.get("toId");
          const currentId = store.getCurrentSharedExpenseId();

          if (fromId === toId) {
            alert("No puedes registrar un pago a la misma persona");
            return;
          }

          store.addPayment({
            id: Date.now().toString(),
            sharedExpenseId: currentId,
            fromId,
            toId,
            amount: parseFloat(formData.get("amount")),
            date: new Date().toISOString(),
          });
          currentView = "dashboard";
          render();
        }
      });

      store.subscribe(render);
      render();
    </script>
  </body>
</html>
