rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /environments/{env} {

      // Global Contacts - anyone authenticated can read/create
      match /globalContacts/{contactId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update: if request.auth != null && 
        // Only allow linking to self
        (request.resource.data.appUserId == request.auth.uid ||
        resource.data.appUserId == null);
      }

      // Users
      match /users/{userId} {
        allow read, write: if request.auth.uid == userId;

        // Contact Aliases
        match /contactAliases/{contactId} {
          allow read, write: if request.auth.uid == userId;
        }

        // Shared Expenses
        match /sharedExpenses/{seId} {
          // Can read if user is in confirmedUserIds
          allow read: if request.auth.uid in resource.data.confirmedUserIds;

          // Can create if user is the creator
          allow create: if request.auth.uid == userId;

          // Can update if user is admin (check via adminContactIds + globalContact)
          allow update: if request.auth.uid in resource.data.confirmedUserIds;

          // Expenses
          match /expenses/{expenseId} {
            allow read: if request.auth.uid in 
            get(/databases/$(database)/documents/environments/$(env)/users/$(userId)/sharedExpenses/$(seId)).data.confirmedUserIds;
            allow create, delete: if request.auth.uid in 
            get(/databases/$(database)/documents/environments/$(env)/users/$(userId)/sharedExpenses/$(seId)).data.confirmedUserIds;
          }

          // Payments
          match /payments/{paymentId} {
            allow read: if request.auth.uid in 
            get(/databases/$(database)/documents/environments/$(env)/users/$(userId)/sharedExpenses/$(seId)).data.confirmedUserIds;
            allow create, delete: if request.auth.uid in 
            get(/databases/$(database)/documents/environments/$(env)/users/$(userId)/sharedExpenses/$(seId)).data.confirmedUserIds;
          }
        }
      }

      // Pending Invitations
      match /pendingInvitations/{invitationId} {
        allow read: if request.auth.token.email == resource.data.email;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null;
      }
    }
  }
}

